name: Update Currency Data

on:
  # Run every day at 00:01 UTC
  schedule:
    - cron: '1 0 * * *'
  
  # Allow manual trigger for testing
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-currency-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}
      
      - name: Fetch and save currency data
        env:
          API_KEY: ${{ secrets.CURRENCY_KEY }}
          API_URL: ${{ secrets.CURRENCY_URL }}
        run: |
          # Configuration
          BASE_CURRENCY="EUR"
          
          # Get current date in UTC
          CURRENT_DATE=$(date -u +"%Y-%m-%d")
          YEAR=$(date -u +"%Y")
          MONTH=$(date -u +"%B")
          FILENAME=$(date -u +"%d-%m-%Y.json")
          
          # Construct directory path
          DATA_DIR="src/Data/${BASE_CURRENCY}/${YEAR}/${MONTH}"
          FILE_PATH="${DATA_DIR}/${FILENAME}"
          
          echo "Fetching currency data for ${CURRENT_DATE}..."
          
          # Check if file already exists
          if [ -f "${FILE_PATH}" ]; then
            echo "Data for ${CURRENT_DATE} already exists"
            exit 0
          fi
          
          # Create directory structure if it doesn't exist
          if [ ! -d "${DATA_DIR}" ]; then
            echo "Creating directory: ${DATA_DIR}"
            mkdir -p "${DATA_DIR}"
          fi
          
          # Fetch data from API
          RESPONSE=$(curl -s -w "\n%{http_code}" "${API_URL}/${CURRENT_DATE}?access_key=${API_KEY}&base=${BASE_CURRENCY}")
          
          # Extract HTTP status code
          HTTP_CODE=$(echo "${RESPONSE}" | tail -n1)
          BODY=$(echo "${RESPONSE}" | sed '$d')
          
          # Check HTTP status
          if [ "${HTTP_CODE}" != "200" ]; then
            echo "Error: HTTP request failed with status ${HTTP_CODE}"
            exit 1
          fi
          
          # Check if API request was successful
          SUCCESS=$(echo "${BODY}" | jq -r '.success // false')
          if [ "${SUCCESS}" != "true" ]; then
            ERROR_INFO=$(echo "${BODY}" | jq -r '.error.info // "Unknown error"')
            echo "Error: API returned - ${ERROR_INFO}"
            exit 1
          fi
          
          # Extract and save only the rates data
          echo "${BODY}" | jq '.rates' > "${FILE_PATH}"
          
          echo "Successfully saved currency data to ${FILE_PATH}"
      
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_TOKEN }}
          commit-message: "chore: update currency data for $(date -u +"%Y-%m-%d")"
          branch: currency-update-${{ github.run_number }}
          delete-branch: true
          title: "Update currency data for $(date -u +"%Y-%m-%d")"
          body: |
            Automated currency exchange rate update
            
            - Date: $(date -u +"%Y-%m-%d")
            - Base Currency: EUR
            
            Auto-generated by GitHub Actions
          labels: automated
      
      - name: Enable auto-merge for PR
        if: steps.cpr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          gh pr merge --auto --squash ${{ steps.cpr.outputs.pull-request-number }}
