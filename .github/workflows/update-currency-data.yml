name: Update Currency Data

on:
  schedule:
    - cron: '1 0 * * *'  # Run daily at 00:01 UTC
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  update-currency-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
      
      - name: Fetch and save currency data
        env:
          API_KEY: ${{ secrets.CURRENCY_KEY }}
          API_URL: ${{ secrets.CURRENCY_URL }}
          BASE_CURRENCY: EUR
        run: |
          set -e
          
          # Get current date in UTC
          CURRENT_DATE=$(date -u +"%Y-%m-%d")
          YEAR=$(date -u +"%Y")
          MONTH=$(date -u +"%B")
          FILENAME=$(date -u +"%d-%m-%Y.json")
          
          # Construct paths
          DATA_DIR="src/Data/${BASE_CURRENCY}/${YEAR}/${MONTH}"
          FILE_PATH="${DATA_DIR}/${FILENAME}"
          
          echo "ðŸ“… Fetching currency data for ${CURRENT_DATE}"
          
          # Check if file already exists
          if [ -f "${FILE_PATH}" ]; then
            echo "âœ“ Data for ${CURRENT_DATE} already exists at ${FILE_PATH}"
            exit 0
          fi
          
          # Create directory structure
          mkdir -p "${DATA_DIR}"
          echo "âœ“ Created directory: ${DATA_DIR}"
          
          # Fetch data from API
          echo "ðŸŒ Calling API..."
          RESPONSE=$(curl -s -w "\n%{http_code}" "${API_URL}/${CURRENT_DATE}?access_key=${API_KEY}&base=${BASE_CURRENCY}")
          
          # Extract HTTP status and body
          HTTP_CODE=$(echo "${RESPONSE}" | tail -n1)
          BODY=$(echo "${RESPONSE}" | sed '$d')
          
          # Validate HTTP status
          if [ "${HTTP_CODE}" != "200" ]; then
            echo "âŒ HTTP request failed with status ${HTTP_CODE}"
            exit 1
          fi
          
          # Validate API response
          SUCCESS=$(echo "${BODY}" | jq -r '.success // false')
          if [ "${SUCCESS}" != "true" ]; then
            ERROR_INFO=$(echo "${BODY}" | jq -r '.error.info // "Unknown error"')
            echo "âŒ API Error: ${ERROR_INFO}"
            exit 1
          fi
          
          # Extract and save rates
          echo "${BODY}" | jq -S '.rates' > "${FILE_PATH}"
          
          echo "âœ… Successfully saved currency data to ${FILE_PATH}"
      
      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GH_TOKEN }}
          commit-message: 'chore: update currency data'
          branch: currency-update-${{ github.run_number }}
          delete-branch: true
          title: 'ðŸ’± Update Currency Data'
          body: |
            ## Automated Currency Data Update
            
            ðŸ“Š **Base Currency:** EUR  
            ðŸ”„ **Workflow Run:** #${{ github.run_number }}  
            ðŸ¤– **Triggered by:** GitHub Actions
            
            This PR contains the latest currency exchange rates.
          labels: automated,currency-data
      
      - name: Auto-merge Pull Request
        if: steps.cpr.outputs.pull-request-number != ''
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          PR_NUMBER: ${{ steps.cpr.outputs.pull-request-number }}
        run: |
          echo "ðŸ”€ Enabling auto-merge for PR #${PR_NUMBER}"
          gh pr merge --auto --squash "${PR_NUMBER}"
          echo "âœ… Auto-merge enabled"
